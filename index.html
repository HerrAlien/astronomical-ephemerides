<html>

<head>
    <title>Astronomical Ephemeris</title>
	<link rel="stylesheet" type="text/css" href="style/default.css"  />

</head>

<body>
    <div id="SunPage" class="page invisible">
    The table gives the apparent RA, Dec. and diameter of the Sun, the UT of transit across the
Greenwich meridian, and P, B<sub>0</sub>, L<sub>0</sub> where:
<ul><li>P is the position angle of the N end of the axis of rotation. It is positive when east of
the north point of the disk, negative if west;</li>
<li>B<sub>0</sub> is the heliographic latitude of the centre of the disk;</li>
<li>L<sub>0</sub> is the heliographic longitude of the centre of the disk.</li>
</ul>
        <table id="Sun">
            <tr class="fixed">
                <th>Date</th>
                <th></th>
                <th>RA<br>h&nbsp;&nbsp;m&nbsp;&nbsp;s</th>
                <th>Dec.<br>&deg;&nbsp;&nbsp;'&nbsp;&nbsp;''</th>
                <th>Diam.<br>&nbsp;&nbsp;'&nbsp;&nbsp;''</th>
                <th>Transit<br>h&nbsp;&nbsp;m&nbsp;&nbsp;s</th>
                <th>P<br>&deg;</th>
                <th>B<sub>0</sub><br>&deg;</th>
                <th>L<sub>0</sub><br>&deg;</th>
            </tr>

        </table>
    </div>
</body>

</html>
<script type="text/JavaScript" src="js/aajs.js"></script>

<script type="text/JavaScript">

//! ST in hours and fraction of hours
function ST2NextJD(ST, initialJD) {
    var accurracy = 1 / (24 * 3600);
    var errorFraction = 0.95 * 1 / 24;

    var jd = initialJD;
    var computeError = function (jd, ST) {
        return AAJS.Date.JD2ST(jd) / 15 - ST;
    }
    
    var error = computeError(jd, ST);
    while (Math.abs(error) > accurracy) {
        if (error > 0) {
            error -= 24;
        }
        
        jd += Math.abs(error) * errorFraction;
        error = computeError(jd, ST);
    }
    return jd;
}

var SunData = {
    cache : {},
    getDataForJD : function (JD) {
        var line = this.cache[JD];
        if (!line) {
            line = [];
            
            var _date = AAJS.Date.JD2Date(JD);
            // convert from JD to gregorian
            line[0] = _date.M;
            line[1] = _date.D;
            
            var radec = AAJS.Sun.EquatorialCoordinates(JD, true);
            line[2] = radec.X; // RA [h.hhhh]
            line[3] = radec.Y; // DEC [deg.dddd]
            line[4] = AAJS.Sun.Diameter(JD, true)/3600; // [deg.dddd]
            // transit should be computed from the RA (LST to UTC conversion)
            var jdOfTransit = ST2NextJD(radec.X, JD);
            radec = AAJS.Sun.EquatorialCoordinates(jdOfTransit - 30 /(24 * 60), true);
            jdOfTransit = ST2NextJD(radec.X, jdOfTransit);
/*            radec = AAJS.Sun.EquatorialCoordinates(jdOfTransit - 1 /(24 * 60), true);
            jdOfTransit = ST2NextJD(radec.X, JD);
            radec = AAJS.Sun.EquatorialCoordinates(jdOfTransit - 1 /(24 * 60 * 60), true);
            jdOfTransit = ST2NextJD(radec.X, JD);
         */
            var transitHour = 24 * (jdOfTransit - JD);
            line[5] = transitHour;
            var physical = AAJS.Sun.CalculatePhysicalDetails(JD, true);
            line[6] = physical.P; // [deg.dddd]
            line[7] = physical.B0; // [deg.dddd]
            line[8] = physical.L0; // [deg.dddd]
        }
        this.cache[JD] = line;
        return line;
    },
    initFromLocalStorage : function () {
        // TODO: this is where we fetch data already computed during earlier sessions
    }
};
SunData.initFromLocalStorage();

var SunPage = {
    page : document.getElementById("SunPage"),
    table : document.getElementById("Sun"),

    reset : function () {
        while (this.table.hasChildNodes()) {
            var currentTr = this.table.lastElementChild;
            if (currentTr.className == "fixed") // not the safest way
                break;
            this.table.removeChild(currentTr);
        }
    },
    
    prepareLineForView : function (line) {
        var displayableLine = [];
        // copy the day verbatim
        displayableLine[1] = line[1];
        if (line[1] == 1) { // first day of the month
            var months = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            displayableLine[0] = months[line[0]]; // set displayableLine[0] to the name of the month
        }
        else
            displayableLine[0] = "";
        
        var sexagesimalRA = AAJS.Numerical.ToSexagesimal(line[2]);
        displayableLine[2] = sexagesimalRA.Ord3 + " " + sexagesimalRA.Ord2 + " " + sexagesimalRA.Ord1;

        var sexagesimalDec = AAJS.Numerical.ToSexagesimal(line[3]);
        displayableLine[3] = sexagesimalDec.Ord3 + " " + sexagesimalDec.Ord2 + " " + sexagesimalDec.Ord1;
        
        var sexagesimalDiam = AAJS.Numerical.ToSexagesimal(line[4]);
        displayableLine[4] = sexagesimalDiam.Ord2 + " " + sexagesimalDiam.Ord1;
        
        var sexagesimalTransit = AAJS.Numerical.ToSexagesimal(line[5]);
        displayableLine[5] = sexagesimalTransit.Ord3 + " " + sexagesimalTransit.Ord2 + " " + sexagesimalTransit.Ord1;
        
        displayableLine[6] = AAJS.Numerical.RoundTo3Decimals (line[6]);
        displayableLine[7] = AAJS.Numerical.RoundTo3Decimals (line[7]);
        displayableLine[8] = AAJS.Numerical.RoundTo3Decimals (line[8]);

        return displayableLine;
    },
    
    // this will probably become an utility available for every page
    appendLine : function (dataArray) {
        var line = this.table.ownerDocument.createElement("tr");
        var tbody = this.table.getElementsByTagName("tbody")[0];
        tbody.appendChild(line);
        
        var i = 0;
        for (i = 0; i < dataArray.length; i++) {
            var td = line.ownerDocument.createElement("td");
            line.appendChild(td);
            td.textContent = dataArray[i];
        }
    }
};


(function(){
    var JD = AAJS.Date.DateToJD (2017, 1, 3, true);
    var i = 0;
//    for (i = 0; i < 365; i++)
        SunPage.appendLine (SunPage.prepareLineForView(SunData.getDataForJD(JD + i)));
})();

</script>
