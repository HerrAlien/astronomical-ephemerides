<html>
<body>
<pre id="pre">
</pre>
</body>
</html>


<script>

            var Pages = {};

         var Location = {
            latitude  : 44.4268,
            longitude : 26.1025,
            altitude  : 300,
            
            rhoSinPhi : 0,
            rhoCosPhi : 0,
            recomputeGeocentricCoordinates : function () {
            Location.rhoSinPhi = AAJS.Globe.RadiusTimesSineGeocentricLatitude (Location.latitude, Location.altitude);
            Location.rhoCosPhi = AAJS.Globe.RadiusTimesCosineGeocentricLatitude (Location.latitude, Location.altitude);
            }

        }; 
       
        var Timeout = {onInit: 1000};

        function PlanetPage() {}

        function GetAAJS() { return AAJS; }

        var SyncedTimeOut = setTimeout;

</script>

<script src="js/aajs.js"></script>
<script type="text/JavaScript" src="js/planetdata.js"></script>
<script src="js/occultations.js"></script>
<script src="js/occultablestars.js"></script>
<script src="js/realtimedata.js"></script>
<script src="js/notifications.js"></script>
<script src="js/moon.js"></script>

<script>


(function() {
    // get a JD

    function getOccultedStars(JDE, numberOfDays) {
        return Occultations.getOccultedStars(JDE, numberOfDays);
    }

        function sind (x) {
            return Math.sin(x * Math.PI/180);
        }
        function cosd (x) {
            return Math.cos(x * Math.PI/180);
        }

    var getDataObj = Occultations.getDataObj;

    var distance = function  (dataForJd, star) {
        var dist = Math.acos(sind(dataForJd.DecTopo)*sind(star.DEd) + 
                             cosd(dataForJd.DecTopo)*cosd(star.DEd)*cosd(dataForJd.RaTopo*15 - star.RAh*15));
        dist *= 180/Math.PI;
        return dist;
    }

    var getStartOrEndDate = function (star, jde, isForStart) {
        var t = jde;
        var d = 1;
        var lastD = 1;
        var epsD = 3e-4;
        var fraction = 2/24;
        if (isForStart) {
            t -= fraction;
        } else {
            t += fraction;
        }
        var timeStep = (jde - t) / 2;

        var moonData = new DataForNow(MoonData);
        
        for (var i = 0; i < 1000 && Math.abs(d) > epsD; i++) {
            var dataForT = moonData.getInterpolatedData(getDataObj(t, fraction/2, 1e-12));
            var distanceFromCenter = distance(dataForT, star);
            var moonRadius = dataForT.diameter/2;
            d = distanceFromCenter - moonRadius;
            if (lastD * d < 0) {
                timeStep *= -0.5;
            }
            t += timeStep;
            lastD = d;
        }
        return t;
    };


    // 29 oct 2015, 22:30 UTC
    function printOccultedStarsOn29Oct2015() {
        if (typeof AAJS == "undefined" || !AAJS.AllDependenciesLoaded())
                return setTimeout (printOccultedStarsOn29Oct2015, 100);

        var jd = AAJS.Date.DateToJD (2015, 10, 29, true);
        
        var dt = GetAAJS().DynamicalTime.DeltaT(jd)/(3600 * 24);

        var s = getOccultedStars (jd, 1);


        var data = {};

        for (var jdeString in s) {
            var jde = Number(jdeString);
            var stars = s[jdeString];
            for (var hrId in stars) {
                star = stars[hrId];
                data [jdeString] = {
                    star : star,
                    start : getStartOrEndDate(star, jde, true) - dt,
                    end : getStartOrEndDate(star, jde, false) - dt
                };
            }
        }


        console.log(s);
        document.getElementById("pre").textContent = JSON.stringify(data, null, 4);
    }

    printOccultedStarsOn29Oct2015();


})();

</script>