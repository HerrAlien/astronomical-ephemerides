<html>
<body>
<pre id="pre">
</pre>
</body>
</html>


<script>

            var Pages = {};

         var Location = {
            latitude  : 44.4268,
            longitude : 26.1025,
            altitude  : 300,
            
            rhoSinPhi : 0,
            rhoCosPhi : 0,
            recomputeGeocentricCoordinates : function () {
            Location.rhoSinPhi = AAJS.Globe.RadiusTimesSineGeocentricLatitude (Location.latitude, Location.altitude);
            Location.rhoCosPhi = AAJS.Globe.RadiusTimesCosineGeocentricLatitude (Location.latitude, Location.altitude);
            }

        }; 
       
        var Timeout = {onInit: 1000};

        function PlanetPage() {}

        function GetAAJS() { return AAJS; }

        var SyncedTimeOut = setTimeout;

</script>

<script src="js/aajs.js"></script>
<script type="text/JavaScript" src="js/planetdata.js"></script>
<script src="js/occultablestars.js"></script>
<script src="js/realtimedata.js"></script>
<script src="js/notifications.js"></script>
<script src="js/moon.js"></script>

<script>


(function() {
    // get a JD
    function sind (x) {
        return Math.sin(x * Math.PI/180);
    }
    function cosd (x) {
        return Math.cos(x * Math.PI/180);
    }

    function getDataObj (JDE) {
        var jd3 =  Math.floor(JDE) + 0.5;
        return { T1: jd3 - 2, T2: jd3 - 1, T3: jd3, T4: jd3 + 1, T5: jd3 + 2, n: JDE - jd3};
    }

    function getOccultedStars(JDE, numberOfDays) {
        
        var occultedStars = {};
        var dayIncrement = 1;
        var moonData = new DataForNow(MoonData);
        var dt = GetAAJS().DynamicalTime.DeltaT(JDE)/(3600 * 24);
        var jde = JDE + dt;
        var stepsCount = 48;
        var jdeIncrement = dayIncrement / stepsCount;
        var handled = {};

        var yearsSince2000 = (jde - 2451545)/365.25;

        for (var d = 0; d < numberOfDays; d += dayIncrement) {

            for (var step = 0; step < stepsCount; step++,  jde += jdeIncrement ) {
                var dataForJd = moonData.getInterpolatedData(getDataObj(jde));
                var ra = dataForJd.RaTopo;
                var dec = dataForJd.DecTopo;
                var starsThatMayBeOcculted = OccultableStars.getStarsNear(ra, dec);

                for (var i = 0; i < starsThatMayBeOcculted.length; i++) {
                    var star = starsThatMayBeOcculted[i];
                    
if (star.Name == "Aldebaran") {
    var a = 0;
    a++;
}

                  
                    // fix precession here - but get both aajs and the MEM file
                    // this time.
/*                    var fixedCoords = AAJS.Precession.PrecessEquatorial( 
                    star.RAh + yearsSince2000 * star.pmRA / (3600), 
                    star.DEd + yearsSince2000 * star.pmDE / (3600), 
                    2451545, jde);
                    star.RAh = fixedCoords.X;
                    star.DEd = fixedCoords.Y;
*/
                    // get the time of conjunction
                    var t = 1;
                    var conjunctionJde = jde;
                    var lastConjunctionJde = 0;
                    for (var tIndex = 0; tIndex < 20 && Math.abs(t) > 1e-6; tIndex++) {
                        dataForJd =  moonData.getInterpolatedData(getDataObj(conjunctionJde));
                        var beforeData = moonData.getInterpolatedData(getDataObj(conjunctionJde - 1/24));
                        t = (star.RAh - beforeData.RaTopo) / (dataForJd.RaTopo - beforeData.RaTopo);
                        conjunctionJde += t / 24;
                    }
                    // interpolate new values for moon
                    
                    var dataAtConjunction = dataForJd;
                    var conjunctionDec = dataAtConjunction.DecTopo;
                    var conjunctionDiameter = dataAtConjunction.diameter;
                    // compute the distance

                    var dist = Math.acos(sind(conjunctionDec)*sind(star.DEd) + 
                                         cosd(conjunctionDec)*cosd(star.DEd));
                    dist *= 180/Math.PI;
                    if (dist <= conjunctionDiameter/2) 
                    {
                        var key = Math.round(conjunctionJde * 1e6) / 1e6;

                        if (!occultedStars[key]) {
                            occultedStars[key] = {};
                        }
                        occultedStars[key][star.HR] = star;
                    }
                    handled[star.HR] = true;
                }
            }

        }
        return occultedStars;
    }

    // 29 oct 2015, 22:30 UTC
    function printOccultedStarsOn29Oct2015() {
        if (typeof AAJS == "undefined" || !AAJS.AllDependenciesLoaded())
                return setTimeout (printOccultedStarsOn29Oct2015, 100);

        var jd = AAJS.Date.DateToJD (2015, 10, 29, true);
        var s = getOccultedStars (jd, 1);
        console.log(s);
        document.getElementById("pre").textContent = JSON.stringify(s, null, 4);
    }

    printOccultedStarsOn29Oct2015();


})();

</script>